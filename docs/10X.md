# 10X workflow

The workflow script that runs the tools is `workflows/kf_single_cell_10x.cwl`

The workflow runs [cellranger count](https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/6.0/using/count),
on fastq files generated by the 10x single cell RNA workflow methodology.
Cell ranger count performs alignment, barcode counting, and filtering.
[SoupX](https://github.com/constantAmateur/SoupX) is used for subtraction of the RNA background.
[Scrublet](https://github.com/swolock/scrublet) is used to score and predict doublets.
Decontaminated outputs are aggregated using the [Seurat](https://satijalab.org/seurat/) R package from the Satija lab at the New York Genome Center.
Overall workflow design heavily cotributed to by Erin Reichenbee of DBHi

## Tools Ran

- Cellranger 6.0.0
- soupX 4.1.0
- scrublet 0.2.3
- Seurat 4.0.4

## Inputs
### multi-step
 - `output_basename`: basename used to name output files
 - `sample_name`: used as prefix for finding fastqs to analyze, e.g. 1k_PBMCs_TotalSeq_B_3p_LT_antibody if the names of the underlying fastqs are of the form 1k_PBMCs_TotalSeq_B_3p_LT_antibody_S1_L001_I1_001.fastq.gz, one per input fastq in the same order
### optional concat and rename step
 - `corrected_read_1_name`: corrected read one names in the 10x expected format 'SampleName_S1_L001_R1_001'. When provided, must be in the same order and same length as the sample name and corrected_read_2_name arrays.
 - `corrected_read_2_name`: corrected read two names in the 10x expected format 'SampleName_S1_L001_R2_001'. When provided, must be in the same order and same length as the sample name and corrected_read_1_name arrays.
### cell ranger
 - `cr_localcores`: Num cores to use for cell ranger, default: 36 
 - `cr_instance_ram`: Ram in GB to make available to cell ranger count step, default: 64
 - `fastq_dir`: directory of fastqs being run. If formatting needed, use r1 and r2 fastqs input instead
 - `r1_fastqs`: If fastqs need to be concat from an old format, populate this
 - `r2_fastqs`: If fastqs need to be concat from an old format, populate this
 - `reference`: directory of reference files
 - `no_bam`: Set to skip generating bam output. Good to keep bam for troubleshooting, but adds to computation time
 - `chemistry`:
   - `auto`: for auto-detection (default)
   - `threeprime`: for Single Cell 3′
   - `fiveprime`: for Single Cell 5′
   - `SC3Pv2`: for Single Cell 3′ v2
   - `SC3Pv3`: for Single Cell 3′ v3
   - `SC3Pv3LT`: for Single Cell 3′ v3 LT
   - `SC3Pv3HT`: for Single Cell 3′ v3 HT
   - `SC5P-PE`: for Single Cell 5′ paired-end (both R1 and R2 are used for alignment)
   - `SC5P-R2`: for Single Cell 5′ R2-only (where only R2 is used for alignment)
   - `SC3Pv1`: for Single Cell 3′ v1. NOTE: this mode cannot be auto-detected. It must be set explicitly with this option
   - `ARC-v1`: for analyzing the GEX portion of multiome data. NOTE: this mode cannot be auto-detected
### scrublet
 - `expected_doublet_rate`: expected doublet rate, usually specific to the method; default 0.06 for 10X
 - `doublet_score_threshold`: doublet cut-off, cells with greater scores will be labelled as doublets; must be between 0 and 1
 - `count_min`: minimum expression count to retain a gene
 - `cell_min`: minimum number of cells a gene must be in to be retained
 - `min_gene_variability_pctl`: Keep the most highly variable genes (in the top min_gene_variability_pctl percentile), as measured by the v-statistic
 - `n_prin_comps`: Number of PCs to use for clustering
 - `ram`: In GB
 - `cpus`: Number of CPUs to request


### Outputs
```yaml
  count_summary: { type: File, outputSource: count/output_summary }
  bam_out: { type: 'File?', outputSource: count/bam }
  decontam_matrix: { type: File, outputSource: seurat_merge/merged_matrix }
  decontam_object: { type: File, outputSource: seurat_merge/merged_object }
  doublet_histogram: { type: File, outputSource: scrublet/score_histogram }
```