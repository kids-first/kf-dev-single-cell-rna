process {
    // favor 6th gen ec2
    withLabel: 'CR'{
        $sbgAWSInstanceHint = ((params.cr_cpus <= 8) ? (params.cr_ram <= 16 ? "c6i.2xlarge" : (params.cr_ram <= 32 ? "m6i.2xlarge" : "r6i.2xlarge")) :
        (params.cr_cpus <= 16) ? (params.cr_ram <= 32 ? "c6i.4xlarge" : (params.cr_ram <= 64 ? "m6i.4xlarge" : "r6i.4xlarge")) :
        (params.cr_cpus <= 32) ? (params.cr_ram <= 64 ? "c6i.8xlarge" : (params.cr_ram <= 128 ? "m6i.8xlarge" : "r6i.8xlarge")) :
        (params.cr_cpus <= 64) ? (params.cr_ram <= 128 ? "c6i.16xlarge" : (params.cr_ram <= 256 ? "m6i.16xlarge" : "r6i.16xlarge")) :
        null)
    }
    // Clear out FASTQs, transcriptome, and all but output tar results
    withName: COUNT {
        afterScript = { "rm -rf fastqs ${reads.join(' ')} ${mates.join(' ')} ${indices ? indicies.join('') : ""} $transcriptome && ls -d $sample/* | grep -v outs | xargs -IFN rm -rf FN" }
    }
    // Keep only per_sample_outs from outs folder, not interested in mutli dir or other files above that per sample level
    withName: MULTI {
        afterScript = { "rm -rf FASTQS $sample_sheet $probe_set_csv $transcriptome && \
        find $library_fastq_id/ -mindepth 1 -maxdepth 1 | grep -v outs | xargs -IFN rm -rf FN && \
        find $library_fastq_id/outs/ -mindepth 1 -maxdepth 1 | grep -v per_sample_outs | xargs -IFN rm -rf FN" }
    }
    withName: UNTAR_REF {
        afterScript = { "rm $tar_file" }
        $sbgAWSInstanceHint = 'c5.2xlarge'
    }
    withName: TAR_DIR {
        afterScript = { "rm -rf $input_dir" }
        $sbgAWSInstanceHint = 'c5.2xlarge'
    }
}